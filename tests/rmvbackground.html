<html>
	<head>
		<script type="text/javascript">
		  function load() 
		  { 
		  	var debug	= 0;
		  	var convert2luma = 1;
		  	var invertRGB = 0;

		  	var useRange	= 1;
		  	var useAverage = 0;

		    var lowTolerance = 1.1;
		    var highTolerance = 2;

		    var maxWidth  = 512;
		    var maxHeight = 512;
		    var globalAlpha = 0.7;
		    var img1filename = 'bckgroundperson.jpg';
		    var img2filename = 'bckground.jpg';
		    var img4filename = 'campanille.jpg';

		    document.getElementById("canvasa").width = maxWidth;
		    document.getElementById("canvasb").width = maxWidth;
		    document.getElementById("canvasc").width = maxWidth;
		    document.getElementById("canvasd").width = maxWidth;

		    document.getElementById("canvasa").height = maxHeight;
		    document.getElementById("canvasb").height = maxHeight;
		    document.getElementById("canvasc").height = maxHeight;
		    document.getElementById("canvasd").height = maxHeight;
		    
				var canvasa = document.getElementById("canvasa");
				var canvasb = document.getElementById("canvasb");
				var canvasc = document.getElementById("canvasc");
				var canvasd = document.getElementById("canvasd");

				var ctxa = canvasa.getContext("2d");
				var ctxb = canvasb.getContext("2d");
				var ctxc = canvasc.getContext("2d");
				var ctxd = canvasd.getContext("2d");
							
				var img1 = loadImage(img1filename, main);
				var img2 = loadImage(img2filename, main);
				var img4 = loadImage(img4filename, main);								

				var imagesLoaded = 0;				
							
				function main() 
				{
					imagesLoaded += 1;
			
					if(imagesLoaded == 3) 
					{					
						ctxa.drawImage(img1, 0, 0, img1.width * (maxWidth/img1.width), img1.height * (maxHeight/img1.height));
						ctxb.drawImage(img2, 0, 0, img2.width * (maxWidth/img2.width), img2.height * (maxHeight/img2.height))	
						ctxd.drawImage(img4, 0, 0, img4.width * (maxWidth/img4.width), img4.height * (maxHeight/img4.height));			

						var imgData1 = ctxa.getImageData(0, 0, maxWidth, maxHeight);
						var imgData2 = ctxb.getImageData(0, 0, maxWidth, maxHeight);				
					  var imgDataOriginal = ctxa.getImageData(0, 0, maxWidth, maxHeight);

					  if (invertRGB)
					  {
					  	invertColors(imgData1);
					  	invertColors(imgData2);
					  }

					  if(convert2luma)
						{
							grayScale(imgData1);
							grayScale(imgData2);
							ctxa.putImageData(imgData1, 0, 0);					
						  ctxb.putImageData(imgData2, 0, 0);		
						}

						var convolutedImgData = convoluteImgs(imgData1, imgData2, imgDataOriginal); 	
						var imgData3 = ctxc.createImageData(maxWidth, maxHeight);			
						
						imgData3.data.set(convolutedImgData);
						
						/*
						if(invertRGB)
							interColors(imgData3)

						if(convert2luma)
							grayScale(imgData3)
						*/

						ctxc.putImageData(imgData3, 0, 0);

						var img3dataURL = canvasc.toDataURL();
						var img3 = new Image();
						img3.src = img3dataURL;
						img3.onload = function(){};

            //can also do ctxd.drawImage(canvasc,0,0) 															
						ctxd.globalAlpha = 0.5;
						ctxd.drawImage(img3, 0, 0);					
					}
				}
				
				function loadImage(src, onload) 
				{
					var img = new Image();
					
					img.onload = onload;
					img.src = src;
			
					return img;
				}
				
			  function convoluteImgs(imgData1, imgData2, imgDataOriginal) 
			  {
			  	if(debug)
			  	{
			  	  console.log('convoluting images');
					  console.log('imgData1.data.length', imgData1.data.length);
					}

			    var dataCopy = new Uint8ClampedArray(imgData1.data.length);
			    var value = -1;

					for(var i = 0; i < imgData1.data.length; i++) 
					{ 
						if(i > 0 && i % 3 == 0) // set alpha to 255
						{
							dataCopy[i] = 255
							i++
						}

					  if(useAverage) 
					  {
					    if
					    ( withinRange(imgData1.data[i  ], imgData2.data[i  ], lowTolerance, highTolerance) && 
					    	withinRange(imgData1.data[i+1], imgData2.data[i+1], lowTolerance, highTolerance) &&
					    	withinRange(imgData1.data[i+2], imgData2.data[i+2], lowTolerance, highTolerance))
					    {
					    	dataCopy[i+=3] = 0;
					    }
					    else 
					    {
					    	dataCopy[i  ] = imgDataOriginal.data[i  ]
					    	dataCopy[i+1] = imgDataOriginal.data[i+1]
					    	dataCopy[i+2] = imgDataOriginal.data[i+2]
					    }
					  } 
					  else if(useRange)
						{
							if(withinRange(imgData1.data[i], imgData2.data[i], lowTolerance, highTolerance))										
								dataCopy[i] = 255;							
						  else
						    dataCopy[i] = imgDataOriginal.data[i];								 
					  }
					  else 
					  {
					  	value = ~~Math.abs(imgData1.data[1] - imgData2.data[i])
					  	dataCopy[i] = value;
					  }
					}  
					return dataCopy;				
			  }
			  
			}

			function grayScale(imageData) 
			{
				for (var i = 0; i < imageData.data.length; i+=4) 
				{
  				imageData.data[i+1] = imageData.data[i+2] = imageData.data[i];
  				imageData.data[i+3] = 255;
				}				
			}

			function invertColors(imageData)
			{
				for(var i = 0; i < imageData.data.length; i += 4) 
				{          
          imageData.data[i] = 255 - imageData.data[i];
          imageData.data[i + 1] = 255 - imageData.data[i + 1];
          imageData.data[i + 2] = 255 - imageData.data[i + 2];
        }
			}

			function withinRange(op1, op2, lowratio, highratio) 
			{ 
				var lowend = ~~(op2 * lowratio);
				var highend = ~~(op2 * highratio);
				
				if(lowend < 0)
				  lowend = 0
				if(highend > 255)
					highend = 255			  
				if(op1 >= lowend && op1 <= highend) 
					return 1;
				return 0;					
			}
			
		/* FILTER PACKET */
		Filters = {};
		Filters.getPixels = function(img) {
		  var c = this.getCanvas(img.width, img.height);
		  var ctx = c.getContext('2d');
		  ctx.drawImage(img);
		  return ctx.getImageData(0,0,c.width,c.height);
		};

		Filters.getCanvas = function(w,h) {
		  var c = document.createElement('canvas');
		  c.width = w;
		  c.height = h;
		  return c;
		};

		Filters.filterImage = function(filter, image, var_args) {
		  var args = [this.getPixels(image)];
		  for (var i=2; i<arguments.length; i++) {
		    args.push(arguments[i]);
		  }
		  return filter.apply(null, args);
		};

		Filters.grayscale = function(pixels, args) {
		  var d = pixels.data;
		  for (var i=0; i<d.length; i+=4) {
		    var r = d[i];
		    var g = d[i+1];
		    var b = d[i+2];
		    // CIE luminance for the RGB
		    // The human eye is bad at seeing red and blue, so we de-emphasize them.
		    var v = 0.2126*r + 0.7152*g + 0.0722*b;
		    d[i] = d[i+1] = d[i+2] = v
		  }
		  return pixels;
		};

		Filters.brightness = function(pixels, adjustment) {
		  var d = pixels.data;
		  for (var i=0; i<d.length; i+=4) {
		    d[i] += adjustment;
		    d[i+1] += adjustment;
		    d[i+2] += adjustment;
		  }
		  return pixels;
		};

		Filters.tmpCanvas = document.createElement('canvas');
		Filters.tmpCtx = Filters.tmpCanvas.getContext('2d');

		Filters.createImageData = function(w,h) {
		  return this.tmpCtx.createImageData(w,h);
		};

		Filters.convolute = function(pixels, weights, opaque) {
		  var side = Math.round(Math.sqrt(weights.length));
		  var halfSide = Math.floor(side/2);
		  var src = pixels.data;
		  var sw = pixels.width;
		  var sh = pixels.height;
		  // pad output by the convolution matrix
		  var w = sw;
		  var h = sh;
		  var output = Filters.createImageData(w, h);
		  var dst = output.data;
		  // go through the destination image pixels
		  var alphaFac = opaque ? 1 : 0;
		  for (var y=0; y<h; y++) {
		    for (var x=0; x<w; x++) {
		      var sy = y;
		      var sx = x;
		      var dstOff = (y*w+x)*4;
		      // calculate the weighed sum of the source image pixels that
		      // fall under the convolution matrix
		      var r=0, g=0, b=0, a=0;
		      for (var cy=0; cy<side; cy++) {
		        for (var cx=0; cx<side; cx++) {
		          var scy = sy + cy - halfSide;
		          var scx = sx + cx - halfSide;
		          if (scy >= 0 && scy < sh && scx >= 0 && scx < sw) {
		            var srcOff = (scy*sw+scx)*4;
		            var wt = weights[cy*side+cx];
		            r += src[srcOff] * wt;
		            g += src[srcOff+1] * wt;
		            b += src[srcOff+2] * wt;
		            a += src[srcOff+3] * wt;
		          }
		        }
		      }
		      dst[dstOff] = r;
		      dst[dstOff+1] = g;
		      dst[dstOff+2] = b;
		      dst[dstOff+3] = a + alphaFac*(255-a);
		    }
		  }
		  return output;
		};
		/* ARRAY TO MATRIX OF SIZE N */
		function listToMatrix(list, elementsPerSubArray) {
    var matrix = [], i, k;

    for (i = 0, k = -1; i < list.length; i++) {
        if (i % elementsPerSubArray === 0) {
            k++;
            matrix[k] = [];
        }

        matrix[k].push(list[i]);
    }

    return matrix;
}
		</script>
	</head>
	<body onload="load();">
		<canvas id="canvasa" style="border: 1px solid black"></canvas>
		<canvas id="canvasb" style="border: 1px solid black"></canvas>
		<canvas id="canvasc" style="border: 1px solid black"></canvas>
		<canvas id="canvasd" style="border: 1px solid black"></canvas>
		<p>TEST 1</p>
	</body>
</html>
