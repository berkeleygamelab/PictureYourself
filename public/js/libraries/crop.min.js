function EdgeList(a){this.leftX=a.leftX;this.rightX=a.rightX;this.topY=a.topY;this.bottomY=a.bottomY;this.defined=true;this.normalized=false}EdgeList.prototype={normalize:function(a,b){if(!this.normalized||b){this.leftX/=a.width;this.rightX/=a.width;this.topY/=a.height;this.bottomY/=a.width}return this},denormalize:function(a,b){if(this.normalized||b){this.leftX*=a.width;this.rightX*=a.width;this.topY*=a.height;this.bottomY*=a.height}return this},getCoordinates:function(){return{topLeft:{x:this.leftX,y:this.topY,},topRight:{x:this.rightX,y:this.topY,},bottomLeft:{x:this.leftX,y:this.bottomY,},bottomRight:{x:this.rightX,y:this.bottomY,},}},getXYWH:function(){return{x:this.bottomY,y:this.leftX,width:this.rightX-this.leftX,height:this.topY-this.bottomY,}},getOpenCVXYWH:function(){return{x:this.leftX,y:this.topY,width:Math.abs(this.rightX-this.leftX),height:Math.abs(this.topY-this.bottomY),}}};function CropJS(b){var c=this;for(var a in b){this[a]=b[a]}if(!this.imageSrc&&!this.image){console.log("required attribute imageSrc/image not defined");return}if(!this.imageContainerID){console.log("required attribute imageContainerID not defined");return}if(!this.selectionRectangleColor){this.selectionRectangleColor="white"}if(!this.image){this.background=new Image();this.background.src=this.imageSrc;this.background.onload=function(){c._initStage()}}else{this.background=this.image;this._initStage()}}CropJS.prototype={_mouse:false,cropEdges:undefined,_fullMask:{init:function(a){this.rect=new Kinetic.Rect({x:0,y:0,width:a._stage.attrs.width,height:a._stage.attrs.height,fill:"black",opacity:0.6,}).on("mouseover",function(){document.body.style.cursor="crosshair"}).on("mouseout",function(){document.body.style.cursor="default"}).on("mousedown touchstart",function(){a.cropEdges={leftX:a._stage.getPointerPosition().x,rightX:a._stage.getPointerPosition().x,topY:a._stage.getPointerPosition().y,bottomY:a._stage.getPointerPosition().y,};a._initSelectionRectangle();a._addSelectionRectangle();a._handles.active="bottomRight";a._removeFullMask()})},add:function(a){a._dynamicLayer.add(this.rect)},remove:function(a){this.rect.remove()},},_selectionRectangle:{init:function(a){this.rect=new Kinetic.Rect({x:a.cropEdges.leftX,y:a.cropEdges.topY,width:a.cropEdges.rightX-a.cropEdges.leftX,height:a.cropEdges.bottomY-a.cropEdges.topY,}).on("mouseover",function(){document.body.style.cursor="move"}).on("mouseout",function(){document.body.style.cursor="default"}).on("mousedown touchstart",function(){a._selectionRectangle.mouse=true;a._selectionRectangle.initialPosition=a._stage.getPointerPosition();a._selectionRectangle.initialEdges=new EdgeList(a.cropEdges)}).on("mousemove touchmove",function(){if(!a._selectionRectangle.mouse){return}var d=a._stage.getPointerPosition(),c=a._selectionRectangle.initialEdges,b=a._selectionRectangle.initialPosition;a.cropEdges.leftX=c.leftX+(d.x-b.x);a.cropEdges.rightX=c.rightX+(d.x-b.x);a.cropEdges.topY=c.topY+(d.y-b.y);a.cropEdges.bottomY=c.bottomY+(d.y-b.y);if(a.cropEdges.leftX<0){a.cropEdges.leftX=0}if(a.cropEdges.leftX>(a._stage.attrs.width-this.attrs.width)){a.cropEdges.leftX=a._stage.attrs.width-this.attrs.width}if(a.cropEdges.rightX<this.attrs.width){a.cropEdges.rightX=this.attrs.width}if(a.cropEdges.rightX>a._stage.attrs.width){a.cropEdges.rightX=a._stage.attrs.width}if(a.cropEdges.topY<0){a.cropEdges.topY=0}if(a.cropEdges.topY>(a._stage.attrs.height-this.attrs.height)){a.cropEdges.topY=a._stage.attrs.height-this.attrs.height}if(a.cropEdges.bottomY<this.attrs.height){a.cropEdges.bottomY=this.attrs.height}if(a.cropEdges.bottomY>a._stage.attrs.height){a.cropEdges.bottomY=a._stage.attrs.height}}).on("mouseup touchend",function(){if(!a._selectionRectangle.mouse){return}a._selectionRectangle.mouse=false;a._selectionRectangle.initialPosition=undefined;a._selectionRectangle.initialEdges=undefined})},add:function(a){a._dynamicLayer.add(this.rect)},remove:function(a){this.rect.remove()},update:function(b){var a=b.cropEdges;this.rect.setX(a.leftX);this.rect.setY(a.topY);this.rect.setWidth(a.rightX-a.leftX);this.rect.setHeight(a.bottomY-a.topY)},},_handles:{init:function(a){this.size=a.handleSize,this.active=undefined,this.topLeft=new Kinetic.Rect({x:a.cropEdges.leftX-a.handleSize/2,y:a.cropEdges.topY-a.handleSize/2,width:this.size,height:this.size,fill:a.selectionRectangleColor,mouse:false,}).on("mouseover",function(){document.body.style.cursor="nw-resize"}).on("mouseout",function(){document.body.style.cursor="default"}).on("mousedown touchstart",function(){if(a._handles.active!==undefined&&a._handles.active!="topLeft"){return}a._handles.active="topLeft"}).on("mousemove touchmove",function(){if(a._handles.active!="topLeft"){return}a.cropEdges.leftX=a._stage.getPointerPosition().x;a.cropEdges.topY=a._stage.getPointerPosition().y}).on("mouseup touchend",function(){a._handles.active=undefined});this.topRight=new Kinetic.Rect({x:a.cropEdges.rightX-this.size/2,y:a.cropEdges.topY-this.size/2,width:this.size,height:this.size,fill:a.selectionRectangleColor,mouse:false,}).on("mouseover",function(){document.body.style.cursor="ne-resize"}).on("mouseout",function(){document.body.style.cursor="default"}).on("mousedown touchstart",function(){if(a._handles.active!==undefined&&a._handles.active!="topRight"){return}a._handles.active="topRight"}).on("mousemove touchmove",function(){if(a._handles.active!="topRight"){return}a.cropEdges.rightX=a._stage.getPointerPosition().x;a.cropEdges.topY=a._stage.getPointerPosition().y}).on("mouseup touchend",function(){a._handles.active=undefined});this.bottomLeft=new Kinetic.Rect({x:a.cropEdges.leftX-this.size/2,y:a.cropEdges.bottomY-this.size/2,width:this.size,height:this.size,fill:a.selectionRectangleColor,mouse:false,}).on("mouseover",function(){document.body.style.cursor="sw-resize"}).on("mouseout",function(){document.body.style.cursor="default"}).on("mousedown touchstart",function(){if(a._handles.active!==undefined&&a._handles.active!="bottomLeft"){return}a._handles.active="bottomLeft"}).on("mousemove touchmove",function(){if(a._handles.active!="bottomLeft"){return}a.cropEdges.leftX=a._stage.getPointerPosition().x;a.cropEdges.bottomY=a._stage.getPointerPosition().y}).on("mouseup touchend",function(){a._handles.active=undefined});this.bottomRight=new Kinetic.Rect({x:a.cropEdges.rightX-this.size/2,y:a.cropEdges.bottomY-this.size/2,width:this.size,height:this.size,fill:a.selectionRectangleColor,mouse:false,}).on("mouseover",function(){document.body.style.cursor="se-resize"}).on("mouseout",function(){document.body.style.cursor="default"}).on("mousedown touchstart",function(){if(a._handles.active!==undefined&&a._handles.active!="bottomRight"){return}a._handles.active="bottomRight"}).on("mousemove touchmove",function(){if(a._handles.active!="bottomRight"){return}a.cropEdges.rightX=a._stage.getPointerPosition().x;a.cropEdges.bottomY=a._stage.getPointerPosition().y}).on("mouseup touchend",function(){a._handles.active=undefined})},add:function(a){a._dynamicLayer.add(this.topLeft);a._dynamicLayer.add(this.topRight);a._dynamicLayer.add(this.bottomLeft);a._dynamicLayer.add(this.bottomRight)},remove:function(a){this.topLeft.remove();this.topRight.remove();this.bottomLeft.remove();this.bottomRight.remove()},update:function(b){var a=b.cropEdges;this.topLeft.setX(a.leftX-this.size/2);this.topLeft.setY(a.topY-this.size/2);this.topRight.setX(a.rightX-this.size/2);this.topRight.setY(a.topY-this.size/2);this.bottomLeft.setX(a.leftX-this.size/2);this.bottomLeft.setY(a.bottomY-this.size/2);this.bottomRight.setX(a.rightX-this.size/2);this.bottomRight.setY(a.bottomY-this.size/2)},},_masks:{init:function(a){this.left=new Kinetic.Rect({x:0,y:0,width:a.cropEdges.leftX,height:a.height,fill:"black",opacity:a.opacity,}).on("mouseover",function(){document.body.style.cursor="crosshair"}).on("mouseout",function(){document.body.style.cursor="default"}).on("mousedown touchstart",function(){a._handles.active="bottomRight";a.cropEdges.leftX=a.cropEdges.rightX=a._stage.getPointerPosition().x;a.cropEdges.topY=a.cropEdges.bottomY=a._stage.getPointerPosition().y;a._updateSelectionRectangle()});this.right=new Kinetic.Rect({x:a.cropEdges.rightX,y:0,width:a.width-a.cropEdges.rightX,height:a.height,fill:"black",opacity:a.opacity,}).on("mouseover",function(){document.body.style.cursor="crosshair"}).on("mouseout",function(){document.body.style.cursor="default"}).on("mousedown touchstart",function(){a._handles.active="bottomRight";a.cropEdges.leftX=a.cropEdges.rightX=a._stage.getPointerPosition().x;a.cropEdges.topY=a.cropEdges.bottomY=a._stage.getPointerPosition().y;a._updateSelectionRectangle()});this.top=new Kinetic.Rect({x:a.cropEdges.leftX,y:0,width:a.cropEdges.rightX-a.cropEdges.leftX,height:a.cropEdges.topY,fill:"black",opacity:a.opacity,}).on("mouseover",function(){document.body.style.cursor="crosshair"}).on("mouseout",function(){document.body.style.cursor="default"}).on("mousedown touchstart",function(){a._handles.active="bottomRight";a.cropEdges.leftX=a.cropEdges.rightX=a._stage.getPointerPosition().x;a.cropEdges.topY=a.cropEdges.bottomY=a._stage.getPointerPosition().y;a._updateSelectionRectangle()});this.bottom=new Kinetic.Rect({x:a.cropEdges.leftX,y:a.cropEdges.bottomY,width:a.cropEdges.rightX-a.cropEdges.leftX,height:a.height-a.cropEdges.bottomY,fill:"black",opacity:a.opacity,}).on("mouseover",function(){document.body.style.cursor="crosshair"}).on("mouseout",function(){document.body.style.cursor="default"}).on("mousedown touchstart",function(){a._handles.active="bottomRight";a.cropEdges.leftX=a.cropEdges.rightX=a._stage.getPointerPosition().x;a.cropEdges.topY=a.cropEdges.bottomY=a._stage.getPointerPosition().y;a._updateSelectionRectangle()})},add:function(a){a._dynamicLayer.add(this.left);a._dynamicLayer.add(this.right);a._dynamicLayer.add(this.top);a._dynamicLayer.add(this.bottom)},remove:function(a){this.left.remove();this.right.remove();this.top.remove();this.bottom.remove()},update:function(b){var a=b.cropEdges;this.top.setX(a.leftX);this.top.setWidth(a.rightX-a.leftX);this.top.setHeight(a.topY);this.bottom.setX(a.leftX);this.bottom.setY(a.bottomY);this.bottom.setWidth(a.rightX-a.leftX);this.bottom.setHeight(b._stage.attrs.height-a.bottomY);this.left.setWidth(a.leftX);this.right.setX(a.rightX);this.right.setWidth(b._stage.attrs.width-a.rightX)},},_initStage:function(){if(!this.width){this.width=this.background.width}if(!this.height){this.height=this.background.height}if(this.cropEdges){this.cropEdges.denormalize(this)}this._stage=new Kinetic.Stage({container:this.imageContainerID,width:this.width,height:this.height,});this._staticLayer=new Kinetic.Layer();this._bgImage=new Kinetic.Image({x:0,y:0,image:this.background,width:this.width,height:this.height,});this._staticLayer.add(this._bgImage);this._stage.add(this._staticLayer);this._dynamicLayer=new Kinetic.Layer();this._stage.add(this._dynamicLayer);this._initFullMask();if(this.cropEdges){this._initSelectionRectangle();this._addSelectionRectangle()}else{this._initFullMask();this._addFullMask()}},_initFullMask:function(){if(this.cropEdges){return}this._fullMask.init(this)},_addFullMask:function(){this._fullMask.add(this);this._dynamicLayer.draw()},_removeFullMask:function(){this._fullMask.remove();this._dynamicLayer.draw()},_initSelectionRectangle:function(){if(!this.cropEdges){return}this._selectionRectangle.init(this);if(!this.handleSize){this.handleSize=10}this._handles.init(this);if(!this.opacity){this.opacity=0.6}this._masks.init(this)},_addSelectionRectangle:function(){var a=this;this._masks.add(this);this._selectionRectangle.add(this);this._handles.add(this);this._dynamicLayer.draw();this._updateSelectionRectangle();this._stage.on("mousemove touchmove",function(){if(a.cropEdges.leftX>a.cropEdges.rightX){var b=a.cropEdges.leftX;a.cropEdges.leftX=a.cropEdges.rightX;a.cropEdges.rightX=b;if(a._handles.active=="topLeft"){a._handles.active="topRight"}else{if(a._handles.active=="topRight"){a._handles.active="topLeft"}else{if(a._handles.active=="bottomLeft"){a._handles.active="bottomRight"}else{if(a._handles.active=="bottomRight"){a._handles.active="bottomLeft"}}}}}if(a.cropEdges.topY>a.cropEdges.bottomY){var b=a.cropEdges.topY;a.cropEdges.topY=a.cropEdges.bottomY;a.cropEdges.bottomY=b;if(a._handles.active=="topLeft"){a._handles.active="bottomLeft"}else{if(a._handles.active=="topRight"){a._handles.active="bottomRight"}else{if(a._handles.active=="bottomLeft"){a._handles.active="topLeft"}else{if(a._handles.active=="bottomRight"){a._handles.active="topRight"}}}}}if(a._handles.active=="topLeft"){a._handles.topLeft.fire("mousemove")}if(a._handles.active=="topRight"){a._handles.topRight.fire("mousemove")}if(a._handles.active=="bottomLeft"){a._handles.bottomLeft.fire("mousemove")}if(a._handles.active=="bottomRight"){a._handles.bottomRight.fire("mousemove")}if(a._selectionRectangle.mouse){a._selectionRectangle.rect.fire("mousemove")}a._updateSelectionRectangle()});this._stage.on("mouseup touchend",function(){a._selectionRectangle.mouse=false;a._handles.active=undefined});this._stage.on("mouseout",function(){a._mouse=false})},_removeSelectionRectangle:function(){this._selectionRectangle.remove();this._handles.remove();this._masks.remove();this._stage.off("mousemove touchmove")},_updateSelectionRectangle:function(){this._selectionRectangle.update(this);this._handles.update(this);this._masks.update(this);this._dynamicLayer.draw()},setCursor:function(a){document.getElementById(this.imageContainerID).style.cursor=a},clearSelection:function(){if(this._selectionRectangle.rect){this._removeSelectionRectangle()}if(this._fullMask.rect){this._removeFullMask()}this.cropEdges=undefined;this._initFullMask();this._addFullMask()},getSelectionRectangle:function(){if(this.cropEdges===undefined){return false}return new EdgeList(this.cropEdges)},cut:function(){console.log("This is the cut function")},};