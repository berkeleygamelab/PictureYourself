var debug_flag=false;var default_background="/images/stickers/0-backgrounds/Asproul.jpg";$(document).ready(function(){$("#selfie").attr("src","../users/"+getCookie("pyuserid")+"/1_sticker.png");$("#toolicon li").on("click",function(){$(this).parent().children().removeClass("active");$(this).addClass("active")});var b="";$(".filter").on("click",function(){var c=$(this).attr("id");if(c=="gray"){b+=" grayscale(0.5)"}else{if(c=="blur"){b+=" blur(5px)"}else{if(c=="sepia"){b+=" sepia(0.5)"}else{if(c=="saturate"){b+=" saturate(0.5)"}else{if(c=="invert"){b+=" invert(100%)"}else{if(c=="opacity"){b+=" opacity(0.5)"}else{if(c=="bright"){b+=" brightness(2)"}else{if(c=="contrast"){b+=" contrast(0.5)"}else{if(c=="reset"){b="blur(0px)"}}}}}}}}}$("#container").css("-webkit-filter",b)});$(".kineticjs-content").css("position","");$("#modal").hide();$("#color_change_canvas").hide()});function ScenarioCtrl(n,j,r,q){var f=800;var d=550;n.loading=false;n.chroma_green=false;n.image_sources={};var p=new Kinetic.Stage({container:"container",width:f,height:d});var s=new Kinetic.Layer();p.add(s);var e=p.getContainer();var k=null;n.image_download="test.jpg";var c=[];$("#color1").colorPicker({onColorChange:function(u,t){n.change_color(t)}});n.backgroundObj=new Image();var o=new Kinetic.Image({image:n.backgroundObj,x:0,y:0,width:f,height:d});n.backgroundObj.src=default_background;n.backgroundObj.onload=function(){debug("Bacground onload");s.add(o);o.setZIndex(1);s.draw()};o.on("click",function(){debug("background click");i()});n.background_update=function(t){n.backgroundObj.src=t.target.src};r.get("/stickers/backgrounds").success(function(t){angular.forEach(t,function(v,u){html="<img src='/"+v+"' class='background' ng-click=\"background_update($event)\" alt='"+u+"'>";compiledElement=q(html)(n);$("#backgrounds_tab").append(compiledElement)})});n.frameObj=new Image();var l=new Kinetic.Image({image:n.frameObj,x:0,y:0,width:f,height:d,});s.add(l);n.frameObj.onload=function(){debug("frame onload");s.add(l);s.draw()};n.frame_update=function(t){debug("frame update");n.frameObj.src=t.target.src};n.remove_frame=function(){debug("remove frame");n.frameObj.src="";s.draw()};var b="shoes_and_pants";var g="shirts";r.get("/stickers").success(function(t){t=angular.fromJson(t);n.visible={};n.stickers=t.stickers;n.categories=t.categories;angular.forEach(n.stickers,function(v,u){n.visible[u]=(u==b);html="<div id="+u+"_subtab class='subtab_title' ng-click=\"toggle('"+u+"')\">"+n.categories[u]+"</div><div ng-show='visible."+u+"' id='"+u+"_content' class='subtab_content'></div>";compiledElement=q(html)(n);$("#sticker_tab").append(compiledElement);angular.forEach(v,function(w){$("#"+u+"_content").append("<img class='sticker "+u+"' src=\"/"+w.source+'" name="'+w.name+'" data-chroma_green="'+w.chroma_green.toString()+'"/>');if(w.chroma_green){n.image_sources[w.name]={fore:w.fore_source,back:w.back_source}}})});$(".sticker").bind("dragstart",function(u){n.dragSrcEl=this;debug($(this).data("chroma_green"));if($(this).data("chroma_green")===true){n.chroma_green=true}else{n.chroma_green=false}});$(".background").bind("dragstart",function(u){n.dragSrcEl=this})});n.toggle=function(t){n.visible[t]=!n.visible[t]};e.addEventListener("dragover",function(t){t.preventDefault()});var i=function(){a=$(p.find(".y, .x, .delete, .rotate"));a.each(function(t){a[t].setVisible(false)});$("#modal").hide();s.draw()};e.addEventListener("drop",function(N){if(!$(n.dragSrcEl).hasClass("background")){i();var v=n.chroma_green;var E=0;imageObj=new Image();imageObj.src=n.dragSrcEl.src;if(v){var t=n.image_sources[n.dragSrcEl.name];var K=new Image();K.src=t.back;var B=new Image();B.src=t.fore;n.selected_background=K}N.preventDefault();x=N.pageX-$("#container").offset().left;y=N.pageY-$("#container").offset().top;size_offset=60;var A=new Kinetic.Group({draggable:true});if(v){var C=new Kinetic.Image({image:K,width:120,height:120,x:x,y:y});var D=new Kinetic.Image({image:B,width:120,height:120,x:x,y:y})}else{var D=new Kinetic.Image({image:imageObj,width:120,height:120,x:x,y:y})}var P={width:120,height:120};var w={x:D.getX()+P.width,y:D.getY()+P.height};var J=new Kinetic.Text({visible:true,text:"",fontFamily:"FontAwesome",fontSize:30,fill:"#eee",stroke:"#222",strokeWidth:2,name:"delete",x:0,y:0});J.on("click",function(){debug("DELETE");debug(s);A.destroy();n.selected_background=null;$("#modal").hide();s.draw()});var R=new Kinetic.Text({x:D.getX()+P.width,y:D.getY()+P.height/2,text:"",fontFamily:"FontAwesome",fontSize:30,fill:"#eee",stroke:"#222",strokeWidth:2,draggable:true,visible:true,name:"x",dragBoundFunc:function(S){return{x:S.x,y:this.getAbsolutePosition().y}}});R.on("dragmove touchmove",function(){var S=this.getAbsolutePosition().x-D.getAbsolutePosition().x-D.getWidth();D.setWidth(D.getWidth()+S*2);D.setAbsolutePosition(D.getAbsolutePosition().x-S/2,D.getAbsolutePosition().y);if(v){C.setWidth(D.getWidth());C.setAbsolutePosition(D.getAbsolutePosition().x,D.getAbsolutePosition().y)}F();s.draw()});var Q=new Kinetic.Text({x:D.getX()+P.width/2,y:D.getY()+P.height,text:"",fontFamily:"FontAwesome",fontSize:30,fill:"#eee",stroke:"#222",strokeWidth:2,draggable:true,visible:true,name:"y",dragBoundFunc:function(S){return{x:this.getAbsolutePosition().x,y:S.y}}});Q.on("dragmove touchmove",function(){var S=this.getAbsolutePosition().y-D.getAbsolutePosition().y-D.getHeight();D.setHeight(D.getHeight()+S*2);D.setAbsolutePosition(D.getAbsolutePosition().x,D.getAbsolutePosition().y-S/2);if(v){C.setHeight(D.getHeight());C.setAbsolutePosition(D.getAbsolutePosition().x,D.getAbsolutePosition().y)}F();s.draw()});var H=new Kinetic.Text({x:0,y:0,text:"",fontFamily:"FontAwesome",fontSize:30,fill:"#eee",stroke:"#222",strokeWidth:2,draggable:true,visible:true,name:"rotate",dragBoundFunc:function(W){var T=D.getAbsolutePosition().x+P.width/2;var V=D.getAbsolutePosition().y+P.height/2;var S=Math.sqrt(Math.pow(D.getWidth()/2,2)+Math.pow(D.getWidth()/2,2));var U=S/Math.sqrt(Math.pow(W.x-T,2)+Math.pow(W.y-V,2));debug(U);debug("x,y: "+T+","+V);return{y:Math.round((W.y-V)*U+V),x:Math.round((W.x-T)*U+T)}}});var G=$("#container").offset();var O=G.left;var M=G.top;var L;var I;D.setOffsetX(P.width/2);D.setOffsetY(P.height/2);H.setOffsetX(P.width/2);H.setOffsetY(P.height/2);R.setOffsetX(P.width/2);R.setOffsetY(P.height/2);Q.setOffsetX(P.width/2);Q.setOffsetY(P.height/2);J.setOffsetX(P.width/2);J.setOffsetY(P.height/2);if(v){C.setOffsetX(P.width/2);C.setOffsetY(P.height/2)}H.on("mouseenter",function(S){L=parseInt(S.clientX-O);I=parseInt(S.clientY-M)});H.on("dragmove touchmove",function(U){start_position={x:D.getAbsolutePosition().x,y:D.getAbsolutePosition().y};rotate_position={x:D.getAbsolutePosition().x+P.width/2,y:D.getAbsolutePosition().y+P.height/2};var T=L-parseInt(U.clientX-O);var S=I-parseInt(U.clientY-M);var V=Math.atan2(S,T);D.setRotation(V);if(v){C.setRotation(V)}s.draw()});n.previous_color=null;A.on("dragmove",function(){if(R.isVisible()&&v){u()}});function u(){var S=D.getAbsolutePosition().x+$("#container").offset().left;var V=D.getAbsolutePosition().y-$("#container").offset().top;var T=D.getWidth()+D.getOffsetX();var U=D.getHeight()+D.getOffsetY();$("#modal").css({left:S-T,top:V+U});$("#modal").show()}n.change_color=function(W){var U=document.getElementById("color_change_canvas");var T=U.getContext("2d");U.width=n.selected_background.width;U.height=n.selected_background.height;T.clearRect(0,0,U.width,U.height);T.drawImage(n.selected_background,0,0,U.width,U.height);var ad=0;var ac=0;var ab=n.selected_background.width;var Z=n.selected_background.height;var S=T.getImageData(ad,ac,ab,Z);var Y=S.data;var aa=hexToRgb(W);for(var X=0,V=Y.length;X<V;X+=4){Y[X]=aa.r;Y[X+1]=aa.g;Y[X+2]=aa.b}T.putImageData(S,0,0);n.selected_background.onload=null;n.selected_background.src=U.toDataURL("image/png");s.draw()};D.on("click",function(S){if(R.isVisible()){i();n.selected_background=null}else{i();if(v){u();n.selected_background=K}R.setVisible(true);Q.setVisible(true);J.setVisible(true);H.setVisible(true)}s.draw()});if(v){K.onload=function(){if(E>0){return z()}E++};B.onload=function(){if(E>0){return z()}E++}}else{imageObj.onload=function(){return z()}}var z=function(){if(v){A.add(C);u()}A.add(D);A.add(R);A.add(Q);A.add(J);A.add(H);s.add(A);F();s.draw()};var F=function(){var S=D.getAbsolutePosition().x;var T=D.getAbsolutePosition().y;debug("x: "+S+" y: "+T);H.setAbsolutePosition(S-10,T-10);R.setAbsolutePosition(S+D.getWidth(),T+D.getHeight()/2);Q.setAbsolutePosition(S+D.getWidth()/2,T+D.getHeight());J.setAbsolutePosition(S+D.getWidth(),T)}}});function m(t,w,u){var v={pyuserid:t,data:u};$.ajax({url:"/email",type:"POST",data:v,success:function(){h(t,w)}})}function h(t,v){var u={pyuserid:t,emails:v};$.ajax({url:"/send_email",type:"POST",data:u,success:function(){n.loading=false;n.$apply();$("#dialog-confirm-email").dialog({resizable:false,modal:true,draggable:false,closeOnEscape:false,dialogClass:"email-dialog no-close",buttons:{"Start over":function(){window.location="/"},Continue:function(){$(this).dialog("close")}}}).position({of:"#container"})},error:function(){n.loading=false;n.$apply();alert("There was an issue sending the email.")}})}n.call_email=function(){i();p.draw();var t=prompt("Please enter your friend's email(s)","oski@berkeley.edu, friend@berkeley.edu");if(t!==null){n.loading=true;debug("calling email");t=t.replace(/\s+/g,"");debug(t);pyuserid=getCookie("pyuserid");p.toDataURL({callback:function(u){debug("callback");m(pyuserid,t,u)}})}};n.create_image=function(){debug("called");n.image_download="somethingelse.jpg";p.toDataURL({mimeType:"image/jpg",quality:1,callback:function(u){debug("callback");var t=document.createElement("a");angular.element(t).attr("href",u).attr("download","test.jpg");t.click();debug("click?")}})}}ScenarioCtrl.$inject=["$scope","$resource","$http","$compile"];function debug(b){if(debug_flag){console.log(b)}};