var debug_flag=true;var default_background="/images/stickers/0-backgrounds/ASproul.jpg";$(document).ready(function(){$("#selfie").attr("src","../users/"+getCookie("pyuserid")+"/1_sticker.png");$("#toolicon li").on("click",function(){$(this).parent().children().removeClass("active");$(this).addClass("active")});$(".kineticjs-content").css("position","");$("#modal").hide();$("#color_change_canvas").hide()});function ScenarioCtrl(p,q,m,h,n){var d=800;var b=550;p.loading=false;p.chroma_green=false;p.image_sources={};p.selected_image=null;kinetic=kineticSetup(d,b);var i=kinetic.layer;var j=kinetic.stage;var c=j.container();var o=null;p.image_download="test.jpg";var e=[];$('select[name="colorpicker"]').simplecolorpicker({picker:true}).on("change",function(){l($('select[name="colorpicker"]').val())});p.background=backgroundSetup(g,default_background,i,j);p.background_update=function(r){p.background.getImage().src=r.target.src};grabBackgroundImages(p,m,h);grabStickerImages(p,m,h);p.toggle=function(r){p.visible[r]=!p.visible[r]};c.addEventListener("dragover",function(r){r.preventDefault()});var g=function(){a=$(j.find(".y, .x, .delete, .rotate, .background"));a.each(function(r){a[r].visible(false)});$("#modal").hide();i.draw()};c.addEventListener("drop",function(E){E.preventDefault();g();var F=p.chroma_green;imageObj=new Image();imageObj.src=p.dragSrcEl.src;var t=null;if(F){var s=p.image_sources[p.dragSrcEl.name];t=new Image();t.src=s.back;imageObj.src=s.fore;p.selected_background=t}x=E.pageX-$("#container").offset().left;y=E.pageY-$("#container").offset().top;var u={width:120,height:120};var w=n.newSticker(imageObj,{x:x,y:y},u,i,t);p.selected_sticker=w;w.delete_icon.on("click",function(){debug("DELETE");w.group.destroy();p.selected_background=null;p.selected_sticker=null;$("#modal").hide();i.draw()});w.scalerX.on("dragmove touchmove",function(){var H=Math.abs(this.x()-w.image.x());w.image.width(H*2);w.image.offsetX(H);if(F){w.imageBack.width(w.image.width());w.imageBack.offsetX(H)}w.reposition()});w.scalerY.on("dragmove touchmove",function(){var H=Math.abs(this.y()-w.image.y());w.image.height(H*2);w.image.offsetY(H);if(F){w.imageBack.height(w.image.height());w.imageBack.offsetY(H)}w.reposition();i.draw()});var C;var A;var G=w.image.getWidth()/2;var z=w.image.getHeight()/2;var B,D;var r;function v(H){if(H>Math.PI){H=H-2*Math.PI}return H*180/Math.PI}w.rotate.on("dragstart",function(H){C=j.getPointerPosition().x-w.image.getAbsolutePosition().x;A=j.getPointerPosition().y-w.image.getAbsolutePosition().y;B=Math.atan2(A,C);r=w.image.rotation()});w.rotate.on("dragmove touchmove",function(H){endX=j.getPointerPosition().x-w.image.getAbsolutePosition().x;endY=j.getPointerPosition().y-w.image.getAbsolutePosition().y;D=Math.atan2(endY,endX);w.group.rotation(r+v(D-B));w.reposition();i.draw()});w.group.on("dragmove",function(){if(w.scalerX.isVisible()&&F){w.move_color()}});w.image.on("click",function(H){debug("Sticker click");if(w.scalerX.isVisible()){g();p.selected_background=null;p.selected_sticker=null}else{g();p.selected_sticker=w;if(p.selected_sticker.previous_color!=null){$('select[name="colorpicker"]').simplecolorpicker("selectColor",p.selected_sticker.previous_color)}if(F){debug("Has Chroma green");w.move_color();p.selected_background=t}w.scalerX.visible(true);w.scalerY.visible(true);w.delete_icon.visible(true);w.rotate.visible(true);w.background.visible(true)}i.draw()})});function k(r,u,s){var t={pyuserid:r,data:s};$.ajax({url:"/email",type:"POST",data:t,success:function(){f(r,u)}})}function f(r,t){p.loading=true;p.$apply();var s={pyuserid:r,emails:t};$.ajax({url:"/send_email",type:"POST",data:s,success:function(){p.loading=false;p.$apply();$("#dialog-confirm-email").dialog({resizable:false,modal:true,draggable:false,closeOnEscape:false,dialogClass:"email-dialog no-close",buttons:{"Start over":function(){window.location="/"},Continue:function(){$(this).dialog("close")}}}).position({of:"#container"})},error:function(){p.loading=false;p.$apply()}})}p.call_email=function(){g();j.draw();var r=prompt("Please enter your friend's email(s)","oski@berkeley.edu, friend@berkeley.edu");if(r!==null){r=r.replace(/\s+/g,"");debug(r);pyuserid=getCookie("pyuserid");j.toDataURL({callback:function(s){debug("callback");k(pyuserid,r,s)}})}};p.create_image=function(){p.image_download="somethingelse.jpg";j.toDataURL({mimeType:"image/jpg",quality:1,callback:function(s){var r=document.createElement("a");angular.element(r).attr("href",s).attr("download","test.jpg");r.click();debug("click?")}})};function l(v){if(p.selected_sticker){p.selected_sticker.previous_color=v}var t=document.getElementById("color_change_canvas");var s=t.getContext("2d");t.width=p.selected_background.width;t.height=p.selected_background.height;s.clearRect(0,0,t.width,t.height);s.drawImage(p.selected_background,0,0,t.width,t.height);var E=0;var D=0;var C=p.selected_background.width;var A=p.selected_background.height;var r=s.getImageData(E,D,C,A);var z=r.data;var B=hexToRgb(v);for(var w=0,u=z.length;w<u;w+=4){z[w]=B.r;z[w+1]=B.g;z[w+2]=B.b}s.putImageData(r,0,0);p.selected_background.onload=null;p.selected_background.src=t.toDataURL("image/png");i.draw()}}function debug(b){if(debug_flag){console.log(b)}}ScenarioCtrl.$inject=["$scope","$resource","$http","$compile","Sticker"];