var debug_flag=true;var default_background="/images/stickers/0-backgrounds/ASproul.jpg";$(document).ready(function(){$("#selfie").attr("src","../users/"+getCookie("pyuserid")+"/1_sticker.png");$("#toolicon li").on("click",function(){$(this).parent().children().removeClass("active");$(this).addClass("active")});$(".kineticjs-content").css("position","");$("#modal").hide();$("#color_change_canvas").hide()});function ScenarioCtrl(o,j,s,r,m){var f=800;var d=550;o.loading=false;o.chroma_green=false;o.image_sources={};o.selected_image=null;var q=new Kinetic.Stage({container:"container",width:f,height:d});var t=new Kinetic.Layer();q.add(t);var e=q.container();var k=null;o.image_download="test.jpg";var c=[];$('select[name="colorpicker"]').simplecolorpicker({picker:true}).on("change",function(){g($('select[name="colorpicker"]').val())});o.backgroundObj=new Image();var p=new Kinetic.Image({image:o.backgroundObj,x:0,y:0,width:f,height:d});o.backgroundObj.src=default_background;o.backgroundObj.onload=function(){debug("Bacground onload");t.add(p);p.setZIndex(1);t.draw()};p.on("click",function(){debug("background click");i()});o.background_update=function(u){o.backgroundObj.src=u.target.src};s.get("/stickers/backgrounds").success(function(u){angular.forEach(u,function(w,v){html="<img src='/"+w+"' class='background' ng-click=\"background_update($event)\" alt='"+v+"'>";compiledElement=r(html)(o);$("#backgrounds_tab").append(compiledElement)})});o.frameObj=new Image();var l=new Kinetic.Image({image:o.frameObj,x:0,y:0,width:f,height:d,});t.add(l);var b="shoes_and_pants";s.get("/stickers").success(function(u){u=angular.fromJson(u);o.visible={};o.stickers=u.stickers;o.categories=u.categories;angular.forEach(o.stickers,function(w,v){o.visible[v]=(v==b);html="<div id="+v+"_subtab class='subtab_title' ng-click=\"toggle('"+v+"')\">"+o.categories[v]+"</div><div ng-show='visible."+v+"' id='"+v+"_content' class='subtab_content'></div>";compiledElement=r(html)(o);$("#sticker_tab").append(compiledElement);angular.forEach(w,function(z){$("#"+v+"_content").append("<img class='sticker "+v+"' src=\"/"+z.source+'" name="'+z.name+'" data-chroma_green="'+z.chroma_green.toString()+'"/>');if(z.chroma_green){o.image_sources[z.name]={fore:z.fore_source,back:z.back_source}}})});$(".sticker").bind("dragstart",function(v){o.dragSrcEl=this;debug($(this).data("chroma_green"));if($(this).data("chroma_green")==true){o.chroma_green=true}else{o.chroma_green=false}})});o.toggle=function(u){o.visible[u]=!o.visible[u]};e.addEventListener("dragover",function(u){u.preventDefault()});var i=function(){a=$(q.find(".y, .x, .delete, .rotate, .background"));a.each(function(u){a[u].visible(false)});$("#modal").hide();t.draw()};e.addEventListener("drop",function(H){H.preventDefault();i();var I=o.chroma_green;imageObj=new Image();imageObj.src=o.dragSrcEl.src;var w=null;if(I){var v=o.image_sources[o.dragSrcEl.name];w=new Image();w.src=v.back;imageObj.src=v.fore;o.selected_background=w}x=H.pageX-$("#container").offset().left;y=H.pageY-$("#container").offset().top;var z={width:120,height:120};var B=m.newSticker(imageObj,{x:x,y:y},z,t,w);o.selected_sticker=B;B.delete_icon.on("click",function(){debug("DELETE");B.group.destroy();o.selected_background=null;o.selected_sticker=null;$("#modal").hide();t.draw()});B.scalerX.on("dragmove touchmove",function(){var K=Math.abs(this.x()-B.image.x());B.image.width(K*2);B.image.offsetX(K);if(I){B.imageBack.width(B.image.width());B.imageBack.offsetX(K)}B.reposition()});B.scalerY.on("dragmove touchmove",function(){var K=Math.abs(this.y()-B.image.y());B.image.height(K*2);B.image.offsetY(K);if(I){B.imageBack.height(B.image.height());B.imageBack.offsetY(K)}B.reposition();t.draw()});var F;var D;var J=B.image.getWidth()/2;var C=B.image.getHeight()/2;var E,G;var u;function A(K){if(K>Math.PI){K=K-2*Math.PI}return K*180/Math.PI}B.rotate.on("dragstart",function(K){F=q.getPointerPosition().x-B.image.getAbsolutePosition().x;D=q.getPointerPosition().y-B.image.getAbsolutePosition().y;E=Math.atan2(D,F);u=B.image.rotation()});B.rotate.on("dragmove touchmove",function(K){endX=q.getPointerPosition().x-B.image.getAbsolutePosition().x;endY=q.getPointerPosition().y-B.image.getAbsolutePosition().y;G=Math.atan2(endY,endX);B.group.rotation(u+A(G-E));B.reposition();t.draw()});B.group.on("dragmove",function(){if(B.scalerX.isVisible()&&I){B.move_color()}});B.image.on("click",function(K){debug("Sticker click");if(B.scalerX.isVisible()){i();o.selected_background=null;o.selected_sticker=null}else{i();o.selected_sticker=B;if(o.selected_sticker.previous_color!=null){$('select[name="colorpicker"]').simplecolorpicker("selectColor",o.selected_sticker.previous_color)}if(I){debug("Has Chroma green");B.move_color();o.selected_background=w}B.scalerX.visible(true);B.scalerY.visible(true);B.delete_icon.visible(true);B.rotate.visible(true);B.background.visible(true)}t.draw()})});function n(u,z,v){var w={pyuserid:u,data:v};$.ajax({url:"/email",type:"POST",data:w,success:function(){h(u,z)}})}function h(u,w){o.loading=true;o.$apply();var v={pyuserid:u,emails:w};$.ajax({url:"/send_email",type:"POST",data:v,success:function(){o.loading=false;o.$apply();$("#dialog-confirm-email").dialog({resizable:false,modal:true,draggable:false,closeOnEscape:false,dialogClass:"email-dialog no-close",buttons:{"Start over":function(){window.location="/"},Continue:function(){$(this).dialog("close")}}}).position({of:"#container"})},error:function(){o.loading=false;o.$apply()}})}o.call_email=function(){i();q.draw();var u=prompt("Please enter your friend's email(s)","oski@berkeley.edu, friend@berkeley.edu");if(u!==null){u=u.replace(/\s+/g,"");debug(u);pyuserid=getCookie("pyuserid");q.toDataURL({callback:function(v){debug("callback");n(pyuserid,u,v)}})}};o.create_image=function(){o.image_download="somethingelse.jpg";q.toDataURL({mimeType:"image/jpg",quality:1,callback:function(v){var u=document.createElement("a");angular.element(u).attr("href",v).attr("download","test.jpg");u.click();debug("click?")}})};function g(A){if(o.selected_sticker){o.selected_sticker.previous_color=A}var w=document.getElementById("color_change_canvas");var v=w.getContext("2d");w.width=o.selected_background.width;w.height=o.selected_background.height;v.clearRect(0,0,w.width,w.height);v.drawImage(o.selected_background,0,0,w.width,w.height);var H=0;var G=0;var F=o.selected_background.width;var D=o.selected_background.height;var u=v.getImageData(H,G,F,D);var C=u.data;var E=hexToRgb(A);for(var B=0,z=C.length;B<z;B+=4){C[B]=E.r;C[B+1]=E.g;C[B+2]=E.b}v.putImageData(u,0,0);o.selected_background.onload=null;o.selected_background.src=w.toDataURL("image/png");t.draw()}}function debug(b){if(debug_flag){console.log(b)}}ScenarioCtrl.$inject=["$scope","$resource","$http","$compile","Sticker"];