app.service("Sticker",function(){return{newSticker:function(b,d,r,s,o,l,m){var h={background:null,delete_icon:null,group:null,image:null,imageBack:null,move_color:null,previous_color:null,rotate:null,scalerX:null,scalerY:null,reposition:null,toggleTools:null};var k=0;var a=30;var i=(o!=null);h.group=new Kinetic.Group({draggable:true,x:d.x+r.width/2,y:d.y+r.height/2});h.image=new Kinetic.Image({image:b,width:r.width,height:r.height,x:0,y:0,offsetX:r.width/2,offsetY:r.height/2,});if(i){h.imageBack=new Kinetic.Image({image:o,width:r.width,height:r.height,offsetX:r.width/2,offsetY:r.height/2,x:0,y:0,})}h.background=new Kinetic.Rect({width:r.width,height:r.height,x:0,y:0,offsetX:r.width/2,offsetY:r.height/2,fill:"#00cdcd",visible:true,opacity:0.2,name:"background"});h.delete_icon=new Kinetic.Text({visible:true,text:"",fontFamily:"FontAwesome",fontSize:a,fill:"#eee",stroke:"#222",strokeWidth:0.75,name:"delete",x:r.width/2,y:-r.height/2,offsetX:a/2,offsetY:a/2});h.scalerX=new Kinetic.Text({x:r.width/2,y:r.height/2,offsetX:a/2,offsetY:a/2,text:"",fontFamily:"FontAwesome",fontSize:a,fill:"#eee",stroke:"#222",strokeWidth:0.75,draggable:true,visible:true,name:"x",});h.scalerY=new Kinetic.Text({x:-r.width/2,y:-r.height/2,offsetY:a/2,offsetX:a*13/60,text:"",fontFamily:"FontAwesome",fontSize:a,fill:"#eee",stroke:"#222",strokeWidth:0.75,draggable:true,visible:true,name:"y",});h.rotate=new Kinetic.Text({x:-r.width/2,y:r.height/2,offsetX:a/2,offsetY:a/2,text:"",fontFamily:"FontAwesome",fontSize:a,fill:"#eee",stroke:"#222",strokeWidth:0.75,draggable:true,visible:true,name:"rotate",});h.delete_icon.on("click",function(){h.group.destroy();l.selected_background=null;l.selected_sticker=null;$("#modal").hide();s.draw()});h.scalerX.on("dragmove touchmove",function(){var u=Math.abs(this.x()-h.image.x());h.image.width(u*2);h.image.offsetX(u);if(i){h.imageBack.width(h.image.width());h.imageBack.offsetX(u)}h.reposition()});h.scalerY.on("dragmove touchmove",function(){var u=Math.abs(this.y()-h.image.y());h.image.height(u*2);h.image.offsetY(u);if(i){h.imageBack.height(h.image.height());h.imageBack.offsetY(u)}h.reposition();s.draw()});var q;var n;var e=h.image.getWidth()/2;var j=h.image.getHeight()/2;var t,g;var c;function p(u){if(u>Math.PI){u=u-2*Math.PI}return u*180/Math.PI}h.rotate.on("dragstart",function(u){q=m.getPointerPosition().x-h.image.getAbsolutePosition().x;n=m.getPointerPosition().y-h.image.getAbsolutePosition().y;t=Math.atan2(n,q);c=h.image.rotation()});h.rotate.on("dragmove touchmove",function(u){endX=m.getPointerPosition().x-h.image.getAbsolutePosition().x;endY=m.getPointerPosition().y-h.image.getAbsolutePosition().y;g=Math.atan2(endY,endX);h.group.rotation(c+p(g-t));h.reposition();s.draw()});if(i){h.imageBack.offsetX(r.width/2);h.imageBack.offsetY(r.height/2)}if(i){o.onload=function(){if(k>0){return f()}k++};b.onload=function(){if(k>0){return f()}k++}}else{b.onload=function(){return f()}}var f=function(){if(i){h.group.add(h.imageBack)}h.group.add(h.background);h.group.add(h.image);h.group.add(h.scalerX);h.group.add(h.scalerY);h.group.add(h.delete_icon);h.group.add(h.rotate);s.add(h.group);h.reposition();if(i){h.move_color()}s.draw()};h.move_color=function(){$("#modal").css({left:$(".kineticjs-content").position().left+(h.rotate.getAbsolutePosition().x+h.scalerY.getAbsolutePosition().x)/2-a/2,top:$(".kineticjs-content").position().top+(h.rotate.getAbsolutePosition().y+h.scalerY.getAbsolutePosition().y)/2-a/2});$("#modal").show()};h.reposition=function(){var u=h.image.width()/2;var x=h.image.height()/2;var w=$(".kineticjs-content").position().left;var v=$(".kineticjs-content").position().top;h.rotate.x(-u);h.rotate.y(x);h.scalerX.x(-u);h.scalerX.y(-x);h.scalerY.x(u);h.scalerY.y(x);h.delete_icon.x(u);h.delete_icon.y(-x);h.background.x(0);h.background.y(0);h.background.width(u*2);h.background.height(x*2);h.background.offsetX(u);h.background.offsetY(x)};h.toggleTools=function(u){h.scalerX.visible(u);h.scalerY.visible(u);h.delete_icon.visible(u);h.rotate.visible(u);h.background.visible(u);u&&i?$("#modal").show():$("#modal").hide()};h.group.on("dragmove",function(){if(h.scalerX.isVisible()&&i){h.move_color()}});return h}}});